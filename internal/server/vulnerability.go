package server

import (
	"github.com/b4bay/aspm/internal/server/sarif"
	"gorm.io/gorm"
)

type Vulnerability struct {
	gorm.Model
	VulnerabilityID string `gorm:"index:unique_id,unique" json:"vuln_id"`
	LocationHash    string `gorm:"index:unique_id,unique" json:"location_hash"`
	ProductID       uint   `gorm:"index:unique_id,unique;index;not null"`
	Level           sarif.Level
	Text            string
	CWE             string
	CVE             string
	EngagementID    uint `gorm:"index;not null"`

	// Associations
	Product    Product    `gorm:"constraint:OnDelete:CASCADE;foreignKey:ProductID;references:ID"`
	Engagement Engagement `gorm:"constraint:OnDelete:CASCADE;foreignKey:EngagementID;references:ID"`
}

type StatusPropagation string

const (
	Forward       StatusPropagation = "forward"
	Backward      StatusPropagation = "backward"
	Bidirectional StatusPropagation = "bidirectional"
)

type StatusKind string

const (
	NoImpact      StatusKind = "no_impact"
	Confirmed     StatusKind = "confirmed"
	FalsePositive StatusKind = "false_positive"
	// TODO: https://help.sonatype.com/en/reviewing-security-vulnerabilities.html
)

type Status struct {
	ID              uint64     `gorm:"primaryKey"`
	VulnerabilityID string     `gorm:"index;not null"`
	Kind            StatusKind `gorm:"index;not null"`
	Propagation     StatusPropagation

	// Associations
	Vulnerability Vulnerability `gorm:"constraint:OnDelete:CASCADE;foreignKey:VulnerabilityID;references:ID"`
}
